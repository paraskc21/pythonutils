<html>
  <head>
    <!-- deck.gl standalone bundle -->
    <script src="https://unpkg.com/deck.gl@^9.0.0-beta/dist.min.js"></script>

    <!-- Mapbox dependencies -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />

    <style type="text/css">
      body {margin: 0; padding: 0;}
      #container {width: 100vw; height: 100vh;}
    </style>
  </head>

  <body>
    <div id="container"></div>
    
    <div id="timeline-controls" style="
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-family: Arial, sans-serif;
      z-index: 100;
    ">
      <div style="display: flex; align-items: center; gap: 15px;">
        <button id="playPauseBtn" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Play</button>
        <div style="display: flex; gap: 5px; align-items: center;">
          <small>Speed:</small>
          <button class="speed-btn" data-speed="0.1" style="padding: 6px 10px; background: #555; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px;">0.1x</button>
          <button class="speed-btn" data-speed="0.25" style="padding: 6px 10px; background: #555; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px;">0.25x</button>
          <button class="speed-btn" data-speed="0.5" style="padding: 6px 10px; background: #555; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px;">0.5x</button>
          <button class="speed-btn" data-speed="1" style="padding: 6px 10px; background: #4CAF50; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">1x</button>
          <button class="speed-btn" data-speed="2" style="padding: 6px 10px; background: #555; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px;">2x</button>
          <button class="speed-btn" data-speed="4" style="padding: 6px 10px; background: #555; color: white; border: 1px solid #999; border-radius: 4px; cursor: pointer; font-size: 12px;">4x</button>
        </div>
        <div>
          <small>1-Day Timeline</small><br/>
          <small id="dateRange"></small>
        </div>
        <input 
          type="range" 
          id="timeSlider" 
          min="0" 
          max="100"
          value="0"
          step="1"
          style="flex: 1; height: 6px; cursor: pointer;"
        />
        <div style="min-width: 200px;">
          <small id="currentDate"></small><br/>
          <small id="progressText">0h 0m (0%)</small>
        </div>
      </div>
    </div>
  </body>

  <script type="text/javascript">

  // We'll request time range and per-step positions from the backend
  const TEN_MINUTES_MS = 1000 * 60 * 10;
  let minTime = null;
  let maxTime = null;
  let totalTenMinSteps = 0;
  let isPlaying = false;
  let animationSpeed = 1;

  const timeSlider = document.getElementById('timeSlider');
  const playPauseBtn = document.getElementById('playPauseBtn');

  async function fetchTimeRange() {
    const res = await fetch('/api/time_range');
    if (!res.ok) throw new Error('time range fetch failed');
    const json = await res.json();
    minTime = json.minTime;
    maxTime = json.maxTime;
    totalTenMinSteps = json.tenMinSteps;
    timeSlider.max = totalTenMinSteps;
    const startDate = new Date(minTime).toLocaleDateString();
    const endDate = new Date(maxTime).toLocaleDateString();
    document.getElementById('dateRange').textContent = startDate + ' â†’ ' + endDate;
    document.getElementById('currentDate').textContent = startDate;
  }

  // build icon layer from features (point features returned by API)
  function buildIconLayer(data) {
    return new deck.IconLayer({
      id: 'plane-icons',
      data: data.features,
      iconAtlas: '/static/images/plane.svg',
      iconMapping: { marker: { x: 0, y: 0, width: 64, height: 64, mask: true } },
      getIcon: d => 'marker',
      getSize: d => 28,
      getPosition: d => d.geometry.coordinates,
      getAngle: d => (d.properties.bearing || 0) - 90,
      getColor: d => {
        const p = d.properties.progress || 0;
        if (p < 0.33) return [0,170,239];
        if (p < 0.67) return [100,200,100];
        return [255,100,100];
      },
      pickable: true,
      onClick: info => {
        if (info.object) console.log(info.object.properties);
      }
    });
  }

  // deck init with empty layer
  const deckgl = new deck.DeckGL({
    container: 'container',
    mapboxApiAccessToken: '<your mapbox token>',
    mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    initialViewState: { latitude: 51, longitude: 10, zoom: 3, bearing: 0, pitch: 30 },
    controller: true,
    layers: [],
  });

  async function fetchAndShow(step) {
    const res = await fetch(`/api/positions?step=${step}`);
    if (!res.ok) return;
    const data = await res.json();
    deckgl.setProps({ layers: [ buildIconLayer(data) ] });
  }

  timeSlider.addEventListener('input', async (e) => {
    const step = parseInt(e.target.value, 10);
    const currentTime = minTime + step * TEN_MINUTES_MS;
    document.getElementById('currentDate').textContent = new Date(currentTime).toLocaleString();
    const totalMinutes = Math.floor((currentTime - minTime) / (1000*60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    document.getElementById('progressText').textContent = `${hours}h ${minutes}m (${Math.round((step/totalTenMinSteps)*100)}%)`;
    await fetchAndShow(step);
  });

  // animation loop
  function animateTimeline() {
    if (isPlaying && minTime !== null) {
      const current = parseFloat(timeSlider.value);
      let next = current + (1 * animationSpeed);
      if (next > totalTenMinSteps) next = 0;
      timeSlider.value = next;
      timeSlider.dispatchEvent(new Event('input', { bubbles: true }));
    }
    requestAnimationFrame(animateTimeline);
  }
  animateTimeline();

  playPauseBtn.addEventListener('click', () => {
    isPlaying = !isPlaying;
    playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
    playPauseBtn.style.background = isPlaying ? '#f44336' : '#4CAF50';
  });

  // speed buttons
  document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.speed-btn').forEach(b => { b.style.background = '#555'; b.style.fontWeight = 'normal'; });
      e.target.style.background = '#4CAF50'; e.target.style.fontWeight = 'bold';
      animationSpeed = parseFloat(e.target.getAttribute('data-speed'));
    });
  });

  // initialize
  fetchTimeRange().then(() => {
    // show initial step 0
    timeSlider.value = 0;
    timeSlider.dispatchEvent(new Event('input', { bubbles: true }));
  }).catch(err => console.error(err));

  </script>
</html>